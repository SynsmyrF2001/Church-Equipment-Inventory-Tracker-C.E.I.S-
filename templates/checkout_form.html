{% extends "base.html" %}

{% block title %}{% if action == 'checkout' %}Check Out{% else %}Check In{% endif %} {{ equipment.name }} - Church Equipment Inventory{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="{% if action == 'checkout' %}log-out{% else %}log-in{% endif %}" class="me-2"></i>
                    {% if action == 'checkout' %}Check Out{% else %}Check In{% endif %} Equipment
                </h5>
            </div>
            <div class="card-body">
                <!-- Equipment Info -->
                <div class="alert alert-info mb-4">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="alert-heading mb-2">{{ equipment.name }}</h6>
                            <p class="mb-1"><strong>Category:</strong> {{ equipment.category.title() }}</p>
                            {% if equipment.model %}
                            <p class="mb-1"><strong>Model:</strong> {{ equipment.model }}</p>
                            {% endif %}
                            {% if equipment.location %}
                            <p class="mb-0"><strong>Location:</strong> {{ equipment.location }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-4 text-end">
                            {% if equipment.status == 'available' %}
                                <span class="badge bg-success fs-6">Available</span>
                            {% elif equipment.status == 'in-use' %}
                                <span class="badge bg-warning text-dark fs-6">In Use</span>
                            {% else %}
                                <span class="badge bg-danger fs-6">Maintenance</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Current Checkout Info (for check-in) -->
                {% if action == 'checkin' and current_checkout %}
                <div class="alert alert-warning mb-4">
                    <h6 class="alert-heading">Current Checkout Information</h6>
                    <p class="mb-1"><strong>Checked out by:</strong> {{ current_checkout.checked_out_by }}</p>
                    <p class="mb-1"><strong>Date:</strong> {{ current_checkout.checked_out_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p class="mb-1"><strong>Days out:</strong> {{ current_checkout.duration_days }}</p>
                    {% if current_checkout.expected_return_date %}
                    <p class="mb-1">
                        <strong>Expected return:</strong> {{ current_checkout.expected_return_date.strftime('%Y-%m-%d') }}
                        {% if current_checkout.is_overdue %}
                            <span class="badge bg-danger ms-1">OVERDUE</span>
                        {% endif %}
                    </p>
                    {% endif %}
                    <p class="mb-1"><strong>Condition when checked out:</strong> 
                        <span class="badge bg-{% if current_checkout.condition_out == 'good' %}success{% elif current_checkout.condition_out == 'fair' %}warning{% else %}danger{% endif %}">
                            {{ current_checkout.condition_out.title() }}
                        </span>
                    </p>
                    {% if current_checkout.notes %}
                    <p class="mb-0"><strong>Checkout notes:</strong> {{ current_checkout.notes }}</p>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Form -->
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        {% if action == 'checkout' %}
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.checked_out_by.id }}" class="form-label">{{ form.checked_out_by.label.text }} *</label>
                            {{ form.checked_out_by(class="form-control" + (" is-invalid" if form.checked_out_by.errors else ""), placeholder="Enter your name") }}
                            {% if form.checked_out_by.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.checked_out_by.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.expected_return_date.id }}" class="form-label">{{ form.expected_return_date.label.text }}</label>
                            {{ form.expected_return_date(class="form-control" + (" is-invalid" if form.expected_return_date.errors else "")) }}
                            {% if form.expected_return_date.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.expected_return_date.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Leave blank if return date is unknown</div>
                        </div>
                        {% else %}
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.checked_in_by.id }}" class="form-label">{{ form.checked_in_by.label.text }} *</label>
                            {{ form.checked_in_by(class="form-control" + (" is-invalid" if form.checked_in_by.errors else ""), placeholder="Enter your name") }}
                            {% if form.checked_in_by.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.checked_in_by.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.condition_out.id if action == 'checkout' else form.condition_in.id }}" class="form-label">
                                Equipment Condition *
                            </label>
                            {% if action == 'checkout' %}
                                {{ form.condition_out(class="form-select" + (" is-invalid" if form.condition_out.errors else "")) }}
                                {% if form.condition_out.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.condition_out.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            {% else %}
                                {{ form.condition_in(class="form-select" + (" is-invalid" if form.condition_in.errors else "")) }}
                                {% if form.condition_in.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.condition_in.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            {% endif %}
                            <div class="form-text">
                                {% if action == 'checkout' %}
                                    Assess the current condition before taking
                                {% else %}
                                    Assess the condition upon return
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.notes.id }}" class="form-label">Notes</label>
                        {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows="3", placeholder="Any additional notes or observations...") }}
                        {% if form.notes.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.notes.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    {% if action == 'checkin' %}
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i data-feather="info" class="me-2"></i>
                            Check-in Notes
                        </h6>
                        <ul class="mb-0">
                            <li>If the equipment condition is marked as "Poor", it will automatically be set to maintenance status</li>
                            <li>Please note any damages, missing parts, or issues in the notes section</li>
                            <li>Verify all accessories and cables are returned with the equipment</li>
                        </ul>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('equipment_detail', id=equipment.id) }}" class="btn btn-secondary">
                            <i data-feather="arrow-left" class="me-1"></i>
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-{% if action == 'checkout' %}warning{% else %}success{% endif %}">
                            <i data-feather="{% if action == 'checkout' %}log-out{% else %}log-in{% endif %}" class="me-1"></i>
                            {% if action == 'checkout' %}Check Out Equipment{% else %}Check In Equipment{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set default expected return date to next Sunday (common for church equipment)
document.addEventListener('DOMContentLoaded', function() {
    const returnDateInput = document.getElementById('expected_return_date');
    if (returnDateInput && !returnDateInput.value) {
        const today = new Date();
        const nextSunday = new Date(today);
        nextSunday.setDate(today.getDate() + (7 - today.getDay()));
        returnDateInput.value = nextSunday.toISOString().split('T')[0];
    }
});
</script>
{% endblock %}
