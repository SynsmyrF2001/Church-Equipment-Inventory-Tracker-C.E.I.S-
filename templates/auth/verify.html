{% extends "base.html" %}

{% block title %}Verify Account - Church Equipment Inventory{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white text-center">
                    <h4 class="mb-0">
                        <i data-feather="shield" class="me-2"></i>
                        Verify Your Account
                    </h4>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <p class="lead">We've sent verification codes to secure your account.</p>
                    </div>
                    
                    <!-- Email Verification -->
                    <div id="emailVerification" class="verification-section">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i data-feather="mail" class="me-2"></i>
                                    Email Verification
                                    <span id="emailStatus" class="badge bg-warning ms-2">Pending</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="emailVerifyForm">
                                    <div class="mb-3">
                                        <label for="emailCode" class="form-label">Enter the 6-digit code sent to your email:</label>
                                        <input type="text" class="form-control text-center" id="emailCode" 
                                               name="email_code" placeholder="000000" maxlength="6" required>
                                    </div>
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                        <button type="submit" class="btn btn-success">
                                            <i data-feather="check" class="me-2"></i>
                                            Verify Email
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="resendCode('email')">
                                            <i data-feather="refresh-cw" class="me-2"></i>
                                            Resend Code
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Phone Verification -->
                    <div id="phoneVerification" class="verification-section d-none">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i data-feather="smartphone" class="me-2"></i>
                                    Phone Verification (Optional)
                                    <span id="phoneStatus" class="badge bg-warning ms-2">Pending</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="phoneVerifyForm">
                                    <div class="mb-3">
                                        <label for="phoneCode" class="form-label">Enter the 6-digit code sent to your phone:</label>
                                        <input type="text" class="form-control text-center" id="phoneCode" 
                                               name="phone_code" placeholder="000000" maxlength="6" required>
                                    </div>
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                                        <button type="submit" class="btn btn-success">
                                            <i data-feather="check" class="me-2"></i>
                                            Verify Phone
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="resendCode('phone')">
                                            <i data-feather="refresh-cw" class="me-2"></i>
                                            Resend Code
                                        </button>
                                    </div>
                                </form>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-link text-decoration-none" onclick="skipPhoneVerification()">
                                        Skip phone verification for now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Continue Button -->
                    <div id="continueSection" class="text-center d-none">
                        <div class="alert alert-success">
                            <h5><i data-feather="check-circle" class="me-2"></i>Verification Complete!</h5>
                            <p>Your account has been successfully verified.</p>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg" onclick="continueToApp()">
                            <i data-feather="arrow-right" class="me-2"></i>
                            Continue to Application
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let userId = null;
let hasPhoneNumber = false;
let emailVerified = false;
let phoneVerified = false;

// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
userId = urlParams.get('user_id');
hasPhoneNumber = urlParams.get('has_phone') === 'true';

// Show phone verification if user has phone number
if (hasPhoneNumber) {
    document.getElementById('phoneVerification').classList.remove('d-none');
}

// Email verification form
document.getElementById('emailVerifyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const code = document.getElementById('emailCode').value;
    await verifyCode('email', code);
});

// Phone verification form
document.getElementById('phoneVerifyForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const code = document.getElementById('phoneCode').value;
    await verifyCode('phone', code);
});

async function verifyCode(type, code) {
    try {
        const response = await fetch('/api/auth/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                code: code,
                code_type: type
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            if (type === 'email') {
                emailVerified = true;
                document.getElementById('emailStatus').textContent = 'Verified';
                document.getElementById('emailStatus').className = 'badge bg-success ms-2';
                document.getElementById('emailVerifyForm').style.display = 'none';
                
                // Add success message
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success';
                successDiv.innerHTML = '<i data-feather="check-circle" class="me-2"></i>Email verified successfully!';
                document.getElementById('emailVerification').querySelector('.card-body').appendChild(successDiv);
                
                // Refresh feather icons
                feather.replace();
            } else if (type === 'phone') {
                phoneVerified = true;
                document.getElementById('phoneStatus').textContent = 'Verified';
                document.getElementById('phoneStatus').className = 'badge bg-success ms-2';
                document.getElementById('phoneVerifyForm').style.display = 'none';
                
                // Add success message
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success';
                successDiv.innerHTML = '<i data-feather="check-circle" class="me-2"></i>Phone verified successfully!';
                document.getElementById('phoneVerification').querySelector('.card-body').appendChild(successDiv);
                
                // Refresh feather icons
                feather.replace();
            }
            
            checkCompletion();
        } else {
            showAlert(result.error || 'Verification failed', 'danger');
        }
    } catch (error) {
        showAlert('Network error. Please try again.', 'danger');
    }
}

async function resendCode(type) {
    try {
        const response = await fetch('/api/auth/resend-verification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                code_type: type
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert(`Verification code resent to your ${type}`, 'success');
        } else {
            showAlert(result.error || 'Failed to resend code', 'danger');
        }
    } catch (error) {
        showAlert('Network error. Please try again.', 'danger');
    }
}

function skipPhoneVerification() {
    phoneVerified = true; // Mark as completed (even though skipped)
    document.getElementById('phoneStatus').textContent = 'Skipped';
    document.getElementById('phoneStatus').className = 'badge bg-secondary ms-2';
    document.getElementById('phoneVerifyForm').style.display = 'none';
    
    const skipDiv = document.createElement('div');
    skipDiv.className = 'alert alert-info';
    skipDiv.innerHTML = '<i data-feather="info" class="me-2"></i>Phone verification skipped. You can add this later in your profile.';
    document.getElementById('phoneVerification').querySelector('.card-body').appendChild(skipDiv);
    
    feather.replace();
    checkCompletion();
}

function checkCompletion() {
    const isComplete = emailVerified && (phoneVerified || !hasPhoneNumber);
    
    if (isComplete) {
        document.getElementById('continueSection').classList.remove('d-none');
        
        // Scroll to continue section
        document.getElementById('continueSection').scrollIntoView({ 
            behavior: 'smooth' 
        });
    }
}

function continueToApp() {
    window.location.href = '/auth/login';
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.card-body').firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Auto-format verification codes
document.getElementById('emailCode').addEventListener('input', function(e) {
    this.value = this.value.replace(/\D/g, '');
});

document.getElementById('phoneCode').addEventListener('input', function(e) {
    this.value = this.value.replace(/\D/g, '');
});
</script>
{% endblock %}